<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Modern Dashboard</title>
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
 <link rel="stylesheet" href="style/style6a.css">
  <link rel="stylesheet" href="style/mapi.css">
</head>
  <body>
  







    
  <div class="content">
    <div class="row gy-4">
      <div class="col-12 col-md-7">
   
        <div class="form-container">   
          <div id="map" class="mt-3">
     </div>
  </div>
</div>
    <div class="col-12 col-md-5">
        <div class="table-container">
             <button class="btn btn-success btn-sm mt-2"><i class="bi bi-map"></i> Topo</button>
               <button id="togglePointsBtn" class="btn btn-success mt-2 btn-sm"><i class="bi bi-eye"></i> Hide Points</button>
                 <button class="btn btn-success btn-sm mt-2" onclick="exportToExcel()">
                <i class="bi bi-file-earmark-excel"></i> Export Excel
                </button>
               <button class="btn btn-primary btn-sm mt-2" onclick="printMap()"><i class="bi bi-printer"></i> Print map</button>
              <div class="mb-3  d-flex align-items-center mt-3" style="position: relative;">
               <input type="text" id="excelFilename" required class="form-control me-2" value="" placeholder="Enter filename" style="width: 150px;">
                 <select id="coordFormat" class="form-select" onchange="updateTableFormat()">
                  <option value="latlong">Decimal</option>
                  <option value="dms">DMS</option>
                  <option value="utm">UTM</option>
                </select>
              </div>
              <div class="container-fluid mt-4" > 
                <div class="card shadow-sm border-0">
                  <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Geographic Coordinates</h5>
                  </div>
                  <!--data table-->
                  <div class="table-responsive">
                    <table id="data-table" class="table table-striped table-hover align-middle mb-0 w-100">
                      <thead class="table-light">
                        <tr>
                          <th>Corner</th>
                          <th>Latitude</th>
                          <th>Longitude</th>
                        </tr>
                      </thead>
                      <tbody>
                        <!-- Your data here -->
                      </tbody>
                    </table>
                  </div>
                </div>
             </div>
          </div>
        </div>
      </div>
    </div>
  <div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 340px;">
      <div class="modal-content border-success">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Success!</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <div class="checkmark-container">
            <svg class="checkmark" viewBox="0 0 52 52">
              <circle class="checkmark-circle" cx="26" cy="26" r="25"/>
              <path class="checkmark-check" d="M14 27l7 7 16-16"/>
            </svg>
          </div>
          <p class="mt-3">Coordinates submitted ðŸŽ‰</p>
        </div>
        <div class="modal-footer justify-content-center">
          <button class="btn btn-success px-4" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="script/indexn3.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="script/map11.js"></script>
</body>
</html>
 <script>
  const randomNumber = Math.floor(Math.random() * 100) + 1;
  document.getElementById('excelFilename').value = `coordinates${randomNumber}`;
</script>



<script>

  //sidebar



  // Toggle data panel

let outsideClickListener;

function show() {
  const div = document.getElementById('div1');
  div.classList.toggle('show');

  if (div.classList.contains('show')) {
    if (!outsideClickListener) {
      outsideClickListener = function (event) {
        if (!div.contains(event.target)) {
          div.classList.remove('show');
          document.removeEventListener('click', outsideClickListener);
          outsideClickListener = null;
        }
      };

      setTimeout(() => {
        document.addEventListener('click', outsideClickListener);
      }, 0);
    }
  } else {
    if (outsideClickListener) {
      document.removeEventListener('click', outsideClickListener);
      outsideClickListener = null;
    }
  }
}




//Data details side 

let originalData = [];

document.addEventListener('DOMContentLoaded', function() {
  loadTableData();

  document.getElementById('coordFormat').addEventListener('change', updateTableFormat);
  document.getElementById('exportBtn').addEventListener('click', exportToExcel);
});

function loadTableData() {
  fetch('http://192.168.43.64:3000/data/display_data')
    .then(response => {
      if (!response.ok) throw new Error('Network response was not ok');
      return response.json();
    })
    .then(data => {
      originalData = data;
      renderTable(data, 'latlong');
    })
    .catch(error => {
      console.error('Error fetching data:', error);
      const tableBody = document.querySelector('#data-table tbody');
      tableBody.innerHTML = `<tr><td colspan="3" style="color: red;">Error loading data: ${error.message}</td></tr>`;
    });
}

function renderTable(data, format) {
  const tableBody = document.querySelector('#data-table tbody');
  tableBody.innerHTML = '';

  data.forEach(item => {
    const row = document.createElement('tr');
    let latContent, longContent;

    switch (format) {
      case 'dms':
        latContent = decimalToDMS(item.lat, true);
        longContent = decimalToDMS(item.long, false);
        break;
      case 'utm':
        const utm = decimalToUTM(item.lat, item.long);
        latContent = `${utm.easting}E`;
        longContent = `${utm.northing}N`;
        break;
      default:
        latContent = item.lat;
        longContent = item.long;
    }

    row.innerHTML = `
      <td>${item.corner}</td>
      <td class="lat-cell">${latContent}</td>
      <td class="long-cell">${longContent}</td>
    `;
    tableBody.appendChild(row);
  });

  updateTableHeaders(format);
}

function updateTableHeaders(format) {
  const headers = document.querySelectorAll('#data-table th');
  if (format === 'utm') {
    headers[1].textContent = 'Easting';
    headers[2].textContent = 'Northing';
  } else {
    headers[1].textContent = 'Latitude';
    headers[2].textContent = 'Longitude';
  }
}

function updateTableFormat() {
  const format = document.getElementById('coordFormat').value;
  renderTable(originalData, format);
}

function decimalToDMS(decimal, isLat) {
  const direction = isLat ? (decimal >= 0 ? 'N' : 'S') : (decimal >= 0 ? 'E' : 'W');
  const absDecimal = Math.abs(decimal);
  const degrees = Math.floor(absDecimal);
  const minutesNotTruncated = (absDecimal - degrees) * 60;
  const minutes = Math.floor(minutesNotTruncated);
  const seconds = ((minutesNotTruncated - minutes) * 60).toFixed(2);
  return `${degrees}Â° ${minutes}' ${seconds}" ${direction}`;
}

function decimalToUTM(lat, lng) {
  const zone = Math.floor((lng + 180) / 6) + 1;
  const easting = (lng - (-180 + (zone - 1) * 6)) * 111319.9;
  const northing = lat * 110574;
  return {
    zone: zone,
    easting: easting.toFixed(2),
    northing: northing.toFixed(2)
  };
}

function exportToExcel() {
  if (typeof XLSX === 'undefined') {
    alert('Please wait for the export library to load and try again.');
    return;
  }

  let filename = document.getElementById('excelFilename').value.trim() || 'coordinates_data';
  if (!filename.toLowerCase().endsWith('.xlsx')) {
    filename += '.xlsx';
  }

  const format = document.getElementById('coordFormat').value;
  let formatName;
  switch (format) {
    case 'dms':
      formatName = "COORDINATE FORMAT: DMS (Degrees, Minutes, Seconds)";
      break;
    case 'utm':
      formatName = "COORDINATE FORMAT: UTM (Universal Transverse Mercator)";
      break;
    default:
      formatName = "COORDINATE FORMAT: Decimal Degrees";
  }

  const headers = ['Corner'];
  if (format === 'utm') {
    headers.push('Easting', 'Northing');
  } else {
    headers.push('Latitude', 'Longitude');
  }

  const rows = Array.from(document.querySelectorAll('#data-table tbody tr')).map(row =>
    Array.from(row.cells).map(cell => cell.textContent)
  );

  const worksheetData = [
    [formatName],
    [],
    headers,
    ...rows
  ];

  const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
  if (!worksheet['!merges']) worksheet['!merges'] = [];
  worksheet['!merges'].push({
    s: { r: 0, c: 0 },
    e: { r: 0, c: headers.length - 1 }
  });

  worksheet['A1'].s = {
    font: { bold: true, sz: 14 },
    alignment: { horizontal: 'center' }
  };

  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "Coordinates");
  XLSX.writeFile(workbook, filename);
}

if (typeof XLSX === 'undefined') {
  const script = document.createElement('script');
  script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
  document.head.appendChild(script);
}



// Initialize and draw map
const map = L.map('map').setView([0, 0], 2);

L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

function abbreviateCorner(corner) {
  if (!corner) return '';
  const uppercaseLetters = corner.match(/[A-Z]/g);
  if (uppercaseLetters && uppercaseLetters.length > 1) {
    return uppercaseLetters.join('').slice(0, 2);
  } else if (corner.length > 2) {
    return corner.slice(0, 2).toUpperCase();
  }
  return corner.toUpperCase();
}

function createNumberIcon(label) {
  const text = abbreviateCorner(label);
  return L.divIcon({
    className: 'number-icon',
    html: `<div>${text}</div>`,  // âœ… Fixed: Use backticks for HTML string
    iconSize: [24, 24],
    iconAnchor: [12, 12]
  });
}

let markers = [], polyline = null, areMarkersVisible = true;
const toggleBtn = document.getElementById('togglePointsBtn');
toggleBtn.addEventListener('click', e => {
  e.stopPropagation();
  areMarkersVisible = !areMarkersVisible;
  markers.forEach(m => {
    areMarkersVisible ? map.addLayer(m) : map.removeLayer(m);
  });
  toggleBtn.textContent = areMarkersVisible ? 'Hide Points' : 'Show Points';
});

fetch('http://192.168.0.105:3000/data/display_data')
  .then(res => res.json())
  .then(data => {
    const validData = data
      .map((coord, i) =>
        typeof coord.lat === 'number' && typeof coord.long === 'number'
          ? { latlng: [coord.lat, coord.long], corner: coord.corner || `Point ${i + 1}` }
          : null)
      .filter(Boolean);

    if (validData.length === 0) {
      const info = L.control({ position: 'topright' });
      info.onAdd = () => {
        const el = L.DomUtil.create('div');
        el.innerHTML = '<strong>No data to display!</strong>';
        el.style.background = 'white';
        el.style.padding = '8px';
        el.style.borderRadius = '4px';
        return el;
      };
      info.addTo(map);
      console.error("No valid coordinates.");
      return;
    }

    markers = validData.map(pt => {
      const marker = L.marker(pt.latlng, {
        icon: createNumberIcon(pt.corner),
        riseOnHover: true
      }).bindPopup(
        `<b>${pt.corner}</b><br>Lat: ${pt.latlng[0].toFixed(4)}<br>Long: ${pt.latlng[1].toFixed(4)}`
      ).addTo(map);

      marker.on('mouseover', () => marker.setZIndexOffset(1000));
      marker.on('mouseout', () => marker.setZIndexOffset(0));
      return marker;
    });

    if (validData.length >= 2) {
      polyline = L.polyline(validData.map(pt => pt.latlng), {
        color: 'blue', weight: 4, opacity: 0.7
      }).addTo(map);
      map.fitBounds(validData.map(pt => pt.latlng));
    }
  })
  .catch(err => console.error("Fetch error:", err));

map.on('click', e => {
  L.popup()
    .setLatLng(e.latlng)
    .setContent(`Lat: ${e.latlng.lat.toFixed(4)}<br>Long: ${e.latlng.lng.toFixed(4)}`)
    .openOn(map);
});

function printMap() {
  window.print();
}
</script>