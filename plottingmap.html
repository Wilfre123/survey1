<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Map with Elevation Data</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
 <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <style>

 /* Reset some defaults */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f4;
        }


        
        /* Top Bar Styling */
        header {
            background:#198754;
            padding: 15px 30px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 26px;
            font-weight: bold;
            color: white;
            letter-spacing: 2px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            list-style: none;
        }

        .nav-links li {
            position: relative;
        }

        .nav-links a {
            text-decoration: none;
            color: white;
            font-size: 15px;
            font-weight: 500;
            padding: 8px 10px;
            transition: color 0.3s, transform 0.3s ease;
        }

        .nav-links a:hover {
            color: #f1f1f1;
            transform: translateY(-3px);
        }

        /* Icons */
        .nav-links i {
            margin-right: 5px;
        }

        /* Mobile Hamburger Icon */
        .hamburger {
            display: none;
            flex-direction: column;
            gap: 5px;
            cursor: pointer;
        }

        .hamburger span {
            width: 30px;
            height: 3px;
            background-color: white;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .mapdiv {
            width: 100%;
            box-shadow: rgba(0, 0, 0, 0.1) 0px 0px 5px 0px, rgba(0, 0, 0, 0.1) 0px 0px 1px 0px;
        }

        /* Active Menu for Mobile */
        @media (max-width: 768px) {
           .map{
                z-index: 1;
            }
            .nav-links {
                position: absolute;
                top: 70px;
                right: 30px;
                background-color: #286449;
                border-radius: 8px;
                padding: 20px;
                display: none;
                flex-direction: column;
                gap: 15px;
                box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
                z-index: 2;
            }
            .nav-links.active {
                display: flex;
            }

            .hamburger {
                display: flex;
            }

            .hamburger.open span:nth-child(1) {
                transform: rotate(45deg);
                position: absolute;
                top: 5px;
            }

            .hamburger.open span:nth-child(2) {
                opacity: 0;
            }

            .hamburger.open span:nth-child(3) {
                transform: rotate(-45deg);
                position: absolute;
                top: -5px;
            }
        }











        


  /* Reset and Base */
* {
  box-sizing: border-box;
}

h2 {
  margin-bottom: 8px;
  font-weight: 700;
  color: #222;
}

p {
  margin-top: 0;
  margin-bottom: 24px;
  color: #555;
  font-size: 14px;
}

/* Containers */
.form-container,
.table-container {
  background: #fff;
  padding: 1.5rem;
  border-radius: 10px;
  box-shadow: 0 4px 16px rgba(0, 100, 0, 0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.form-container:hover,
.table-container:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(0, 100, 0, 0.15);
}

/* Buttons */
.btn-dark-green {
  background: linear-gradient(90deg, #064d1d, #0a5f25);
  color: white;
  border: none;
  transition: background 0.3s ease;
}

.btn-dark-green:hover {
  color: white;
  background: linear-gradient(90deg, #0a5f25, #064d1d);
}

/* Checkmark Animation */
.checkmark-container {
  display: flex;
  justify-content: center;
  margin: 10px 0;
}

.checkmark {
  width: 56px;
  height: 56px;
  stroke-width: 3;
  stroke: #fff;
  fill: none;
  box-shadow: inset 0 0 0 #7ac142;
  border-radius: 50%;
  animation: fill 0.4s ease-in-out 0.4s forwards,
             scale 0.3s ease-in-out 0.9s both;
}

.checkmark-circle {
  stroke-dasharray: 166;
  stroke-dashoffset: 166;
  stroke: #7ac142;
  animation: stroke 0.6s forwards;
}

.checkmark-check {
  stroke-dasharray: 48;
  stroke-dashoffset: 48;
  animation: stroke 0.3s 0.6s forwards;
}

@keyframes stroke {
  to {
    stroke-dashoffset: 0;
  }
}

@keyframes scale {
  50% {
    transform: scale(1.1);
  }
}

@keyframes fill {
  to {
    box-shadow: inset 0 0 0 30px #7ac142;
  }
}

/* Div Show/Hide */
#div1 {
  display: block;
}

#div2 {
  display: none;
}

/* Table Styles */
.table1,
table {
  border-collapse: collapse;
  width: 100%;
  background-color: white;
  margin-bottom: 20px;
}

.table1 thead,
thead {
  background-color: #2e8b57;
  color: white;
}

th,
td {
  border: 1px solid #ccc;
  padding: 5px 5px;
  text-align: left;
  min-width: 120px;
  font-size: 11px;
}

th {
  font-weight: bold;
  background-color: green;
}

td[contenteditable="true"] {
  background-color: #f9fbff;
  cursor: text;
  outline: none;
}

td[contenteditable="true"]:focus {
  background-color: #ffffcc;
  outline: 2px solid #4caf50;
  box-shadow: inset 0 0 0 2px #4a90e2;
}

tbody tr:hover td {
  background-color: #f0f6ff;
}

/* Responsive Table */
.table_div {
  width: 100%;
  height: 300px;
  overflow: auto;
}

.table-responsive {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

@media (max-width: 600px) {

  .d1, .d2{
    margin-top: 10px;
  }

  .content1{
    width: 100%;
  }

  table {
    max-width: 90px;
  }

  th,
  td {
    padding: 10px 12px;
  }
}

/* Map */
#map {
  height: 600px;
}

/* Map Marker Icon */
.number-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background-color: rgba(0, 123, 255, 0.6);
  color: white;
  font-size: 12px;
  font-weight: bold;
  text-align: center;
  transition: transform 0.3s, background-color 0.3s;
}

.number-icon:hover {
  transform: scale(1.2);
  background-color: rgba(0, 123, 255, 0.8);
}

.number-icon .icon-text {
  font-size: 12px;
  font-weight: bold;
  color: white;
}

.buttondiv{
  width: 100%;
  height: 50px;
box-shadow: rgba(0, 0, 0, 0.15) 0px 5px 15px 0px;

background-color: rgba(128, 128, 128, 0.5);
}





  .modal.fade .modal-dialog {
      transform: translateY(-50px); /* Start position above */
      opacity: 0; /* Invisible */
      transition: opacity 0.4s ease, transform 0.4s ease; /* Smooth transition for both opacity and transform */
    }

    /* When the modal becomes visible */
    .modal.fade.show .modal-dialog {
      transform: translateY(0); /* Move to its normal position */
      opacity: 1; /* Fully visible */
    }



    .modaldiv{
      height: 400px;
      overflow: auto;
    }




      @media print {
      body * {
        visibility: hidden !important;
      }

      #map, #map * {
        visibility: visible !important;
      }

      #map {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 9999 !important;
      }}
    



      .content1 {
  position: relative;
  width: 100%;
  transition: margin 0.3s ease;
  right: 4px;
}


  </style>
  
  
</head>
<body>

  <header>
    <nav class="top-bar">
        <div class="logo">Land Map</div>


        <ul class="nav-links">
            <li><a href="#"><i class="fas fa-info-circle"></i> About</a></li>
            <li><a href="#"><i class="fas fa-cogs"></i> Services</a></li>
            <li><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
        </ul>

              <div class="hamburger" id="hamburger">
                  <span></span>
                  <span></span>
                  <span></span>
              </div>
          </nav>
      </header>



  <div class="buttondiv mt-2  " >
<div class="mx-2">
  <button id="togglePointsBtn" class="btn btn-success btn-sm mt-2 ">Hide Points</button>
   <button id="togglePointsBtn" class="btn btn-success btn-sm mt-2 "> <i class="bi bi-map"></i> Topo</button>
 <button id="data" class="btn btn-success btn-sm mt-2 " data-bs-toggle="modal" data-bs-target="#exampleModal">
    <i class="bi bi-server"></i> Data
  </button>
   <button class="btn btn-success btn-sm mt-2" onclick="printMap()"><i class="bi bi-printer"></i> Print </button>
 </div>
  </div>  
  

      <div class="row content1 mx-1  p-3 mb-3 mb-md-0" >
          <div class="form-container">
         <select id="lotSelect" class="form-select" style="width: 40%;">
            <option value="" selected disabled>Select a Lot</option>
        </select>
       
      <div id="map" class=" mt-2">

    </div>
  </div>
</div>

  




<!-- Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Data Coordinates</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <center><h4 style="color: green;" id="selectedLotDisplay"></h4></center>

            <button class="btn btn-success btn-sm mt-2" onclick="exportToExcel()">
                <i class="bi bi-file-earmark-excel"></i> Export Excel
                </button>


       

           <div class="mb-3  d-flex align-items-center mt-3" style="position: relative;">
               <input type="text" id="excelFilename" required class="form-control me-2" value="" placeholder="Enter filename" style="width: 150px;">
                 <select id="coordFormat" class="form-select" onchange="updateTableFormat()">
                  <option value="latlong">Decimal</option>
                  <option value="dms">DMS</option>
                  <option value="utm">UTM</option>
                </select>
              </div>

              
              <div class="modaldiv mt-2">
                 <table id="data-table" class="table table-striped table-hover align-middle mb-0 w-100">
                      <thead class="table-light">
                        <tr>
                          <th>Corner</th>
                          <th>Latitude</th>
                          <th>Longitude</th>
                            <th>Elevation</th>
                        </tr>
                      </thead>
                      <tbody>
                        <!-- Your data here -->
                      </tbody>
                    </table>
              </div>


        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

 <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>


   // Hamburger menu toggle
        const hamburger = document.getElementById('hamburger');
        const navLinks = document.querySelector('.nav-links');

        hamburger.addEventListener('click', () => {
            navLinks.classList.toggle('active');
            hamburger.classList.toggle('open');
        });




let originalData = [];

async function fetchAndDisplayTableData(lotId) {
  try {
    const baseUrl = `${window.location.protocol}//${window.location.hostname}:3000`;
    const res = await fetch(`${baseUrl}/data/join/${lotId}`);
    if (!res.ok) throw new Error('Failed to fetch coordinate data');
    const data = await res.json();

    originalData = data;
    renderCoordinateTable(data, document.getElementById('coordFormat').value);
  } catch (err) {
    console.error("Coordinate fetch error:", err);
    document.querySelector('#data-table tbody').innerHTML =
      `<tr><td colspan="4" style="color:red;">${err.message}</td></tr>`;
  }
}

function renderCoordinateTable(data, format) {
  const tbody = document.querySelector('#data-table tbody');
  tbody.innerHTML = '';

  if (!data || data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="color:red;">No data available</td></tr>';
    return;
  }

  data.forEach((item, index) => {
    let lat = '', lng = '';

    if (format === 'dms') {
      lat = decimalToDMS(item.lat, true);
      lng = decimalToDMS(item.long, false);
    } else if (format === 'utm') {
      const utm = decimalToUTM(item.lat, item.long);
      lat = `${utm.easting}E`;
      lng = `${utm.northing}N`;
    } else {
      lat = item.lat.toFixed(6);
      lng = item.long.toFixed(6);
    }

    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${item.corner || ''}</td>
      <td>${lat}</td>
      <td>${lng}</td>
      <td>${item.elevation ?? ''}</td>
    `;

    if (index === 0) {
      row.classList.add('highlight');
    }

    tbody.appendChild(row);
  });

  updateTableHeaders(format);
}

function updateTableHeaders(format) {
  const headers = document.querySelectorAll('#data-table th');
  if (format === 'utm') {
    headers[1].textContent = 'Easting';
    headers[2].textContent = 'Northing';
  } else {
    headers[1].textContent = 'Latitude';
    headers[2].textContent = 'Longitude';
  }
}

function decimalToDMS(decimal, isLat) {
  const dir = isLat ? (decimal >= 0 ? 'N' : 'S') : (decimal >= 0 ? 'E' : 'W');
  const abs = Math.abs(decimal);
  const deg = Math.floor(abs);
  const min = Math.floor((abs - deg) * 60);
  const sec = (((abs - deg) * 60 - min) * 60).toFixed(2);
  return `${deg}° ${min}' ${sec}" ${dir}`;
}

function decimalToUTM(lat, lng) {
  const zone = Math.floor((lng + 180) / 6) + 1;
  const easting = (lng - (-180 + (zone - 1) * 6)) * 111319.9;
  const northing = lat * 110574;
  return {
    zone,
    easting: easting.toFixed(2),
    northing: northing.toFixed(2)
  };
}

function exportToExcel() {
  if (!originalData || originalData.length === 0) {
    alert("No data to export!");
    return;
  }

  const format = document.getElementById('coordFormat').value;
  const selectedLot = document.getElementById('lotSelect').options[document.getElementById('lotSelect').selectedIndex].text;
  
  // Prepare the data
  const exportData = originalData.map(item => {
    let lat = '', lng = '';

    if (format === 'dms') {
      lat = decimalToDMS(item.lat, true);
      lng = decimalToDMS(item.long, false);
    } else if (format === 'utm') {
      const utm = decimalToUTM(item.lat, item.long);
      lat = `${utm.easting}E`;
      lng = `${utm.northing}N`;
    } else {
      lat = item.lat.toFixed(6);
      lng = item.long.toFixed(6);
    }

    return {
      'Corner': item.corner || '',
      [format === 'utm' ? 'Easting' : 'Latitude']: lat,
      [format === 'utm' ? 'Northing' : 'Longitude']: lng,
      'Elevation (m)': item.elevation ?? ''
    };
  });

  // Create workbook
  const workbook = XLSX.utils.book_new();
  
  // Create worksheet with data
  const wsData = [
    [selectedLot], // Title row (will be merged)
    ['Corner', format === 'utm' ? 'Easting' : 'Latitude', 
     format === 'utm' ? 'Northing' : 'Longitude', 'Elevation (m)'], // Header row
    ...exportData.map(item => [
      item['Corner'],
      item[format === 'utm' ? 'Easting' : 'Latitude'],
      item[format === 'utm' ? 'Northing' : 'Longitude'],
      item['Elevation (m)']
    ])
  ];
  
  const worksheet = XLSX.utils.aoa_to_sheet(wsData);
  
  // Merge title cells (A1:D1)
  if (!worksheet['!merges']) worksheet['!merges'] = [];
  worksheet['!merges'].push({ s: { r: 0, c: 0 }, e: { r: 0, c: 3 } });
  
  // Add styling (requires xlsx-style library)
  if (worksheet['!rows']) {
    // Title row styling
    worksheet['!rows'][0] = { hpt: 24, s: { alignment: { horizontal: 'center' }, font: { bold: true, sz: 16 } } };
    // Header row styling
    worksheet['!rows'][1] = { s: { font: { bold: true } } };
  }
  
  // Set column widths
  worksheet['!cols'] = [
    { wch: 15 }, // Corner
    { wch: 25 }, // Latitude/Easting
    { wch: 25 }, // Longitude/Northing
    { wch: 15 }  // Elevation
  ];
  
  // Add worksheet to workbook
  XLSX.utils.book_append_sheet(workbook, worksheet, "Coordinates");

  // Generate filename with format info
  const formatLabel = format === 'dms' ? 'DMS' : format === 'utm' ? 'UTM' : 'Decimal';
  const filename = `${selectedLot.replace(/[^a-z0-9]/gi, '_')}_coordinates_${formatLabel}.xlsx`;
  
  // Export the file
  XLSX.writeFile(workbook, filename);
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
  const lotSelect = document.getElementById('lotSelect');
  const coordFormat = document.getElementById('coordFormat');
  
  // Set up event listeners
  coordFormat.addEventListener('change', () => {
    if (originalData.length > 0) {
      renderCoordinateTable(originalData, coordFormat.value);
    }
  });

  lotSelect.addEventListener('change', async function() {
    const lotId = this.value;
    if (lotId) {
      await fetchAndDisplayTableData(lotId);
    }
  });

  // Initialize with first lot if available
  if (lotSelect.options.length > 1) {
    lotSelect.value = lotSelect.options[1].value;
    lotSelect.dispatchEvent(new Event('change'));
  }
});




        //map
const map = L.map('map').setView([0, 0], 2);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let markers = [], polyline = null, areMarkersVisible = true;
const toggleBtn = document.getElementById('togglePointsBtn');
const lotSelect = document.getElementById('lotSelect');
const lotDisplay = document.getElementById('selectedLotDisplay'); // Added reference to h6 element

function abbreviateCorner(corner) {
    if (!corner) return '';
    const uppercaseLetters = corner.match(/[A-Z]/g);
    if (uppercaseLetters && uppercaseLetters.length > 1) {
        return uppercaseLetters.join('').slice(0, 2);
    } else if (corner.length > 2) {
        return corner.slice(0, 2).toUpperCase();
    }
    return corner.toUpperCase();
}

function createNumberIcon(label) {
    const text = abbreviateCorner(label);
    return L.divIcon({
        className: 'number-icon',
        html: `<div>${text}</div>`,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
    });
}

toggleBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    areMarkersVisible = !areMarkersVisible;
    markers.forEach((m) => {
        areMarkersVisible ? map.addLayer(m) : map.removeLayer(m);
    });
    toggleBtn.textContent = areMarkersVisible ? 'Hide Points' : 'Show Points';
});

async function fetchLotData() {
    try {
        const baseUrl = `${window.location.protocol}//${window.location.hostname}:3000`;
        const response = await fetch(`${baseUrl}/data/display_lot`);
        const lotData = await response.json();

        if (!Array.isArray(lotData) || lotData.length === 0) {
            console.warn("No lots found.");
            return;
        }

        // Clear any existing options
        lotSelect.innerHTML = '<option value="">Select a Lot</option>';
        
        lotData.forEach((lot) => {
            const option = document.createElement('option');
            option.value = lot.id;
            option.textContent = lot.lot;
            lotSelect.appendChild(option);
        });

        // Enable dropdown change handling
        lotSelect.addEventListener('change', async function() {
            const selectedLotId = this.value;
            if (selectedLotId) {
                const selectedOption = this.options[this.selectedIndex];
                lotDisplay.textContent = selectedOption.textContent; // Update h6 with selected lot
                await fetchMapData(selectedLotId);
            } else {
                lotDisplay.textContent = ''; // Clear h6 when no lot is selected
                clearMap();
            }
        });

    } catch (err) {
        console.error("Error fetching lot data:", err);
    }
}

async function fetchMapData(lotId) {
    try {
        clearMap();
        const baseUrl = `${window.location.protocol}//${window.location.hostname}:3000`;

        // Fetch from the join endpoint
        const response = await fetch(`${baseUrl}/data/join/${lotId}`);
        const data = await response.json();

        const validData = data.map((coord, i) =>
            typeof coord.lat === 'number' && typeof coord.long === 'number' && typeof coord.elevation === 'number'
                ? { latlng: [coord.lat, coord.long], corner: coord.corner || `Point ${i + 1}`, elevation: coord.elevation }
                : null
        ).filter(Boolean);

        if (validData.length === 0) {
            const info = L.control({ position: 'topright' });
            info.onAdd = () => {
                const el = L.DomUtil.create('div');
                el.innerHTML = '<strong>No data to display!</strong>';
                el.style.background = 'white';
                el.style.padding = '8px';
                el.style.borderRadius = '4px';
                return el;
            };
            info.addTo(map);
            console.warn("No valid coordinates.");
            return;
        }

        markers = validData.map((pt) => {
            const marker = L.marker(pt.latlng, {
                icon: createNumberIcon(pt.corner),
                riseOnHover: true
            }).bindPopup(
                `<b>${pt.corner}</b><br>Lat: ${pt.latlng[0].toFixed(4)}<br>Long: ${pt.latlng[1].toFixed(4)}<br>Elevation: ${pt.elevation} m`
            ).addTo(map);

            marker.on('mouseover', () => marker.setZIndexOffset(1000));
            marker.on('mouseout', () => marker.setZIndexOffset(0));
            return marker;
        });

        if (validData.length >= 2) {
            polyline = L.polyline(validData.map((pt) => pt.latlng), {
                color: 'blue',
                weight: 4,
                opacity: 0.7
            }).addTo(map);
            map.fitBounds(validData.map((pt) => pt.latlng));
        }

    } catch (err) {
        console.error("Fetch error:", err);
    }
}

function clearMap() {
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];
    if (polyline) {
        map.removeLayer(polyline);
        polyline = null;
    }
}

map.on('click', (e) => {
    L.popup()
        .setLatLng(e.latlng)
        .setContent(`Lat: ${e.latlng.lat.toFixed(4)}<br>Long: ${e.latlng.lng.toFixed(4)}`)
        .openOn(map);
});

function printMap() {
    window.print();
}

fetchLotData();
  </script>

</body>
</html>
