<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Map with Elevation Data</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
 <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <style>

 /* Reset some defaults */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f4;
        }


        
        /* Top Bar Styling */
        header {
            background:#198754;
            padding: 15px 30px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 26px;
            font-weight: bold;
            color: white;
            letter-spacing: 2px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            list-style: none;
        }

        .nav-links li {
            position: relative;
        }

        .nav-links a {
            text-decoration: none;
            color: white;
            font-size: 15px;
            font-weight: 500;
            padding: 8px 10px;
            transition: color 0.3s, transform 0.3s ease;
        }

        .nav-links a:hover {
            color: #f1f1f1;
            transform: translateY(-3px);
        }

        /* Icons */
        .nav-links i {
            margin-right: 5px;
        }

        /* Mobile Hamburger Icon */
        .hamburger {
            display: none;
            flex-direction: column;
            gap: 5px;
            cursor: pointer;
        }

        .hamburger span {
            width: 30px;
            height: 3px;
            background-color: white;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .mapdiv {
            width: 100%;
            box-shadow: rgba(0, 0, 0, 0.1) 0px 0px 5px 0px, rgba(0, 0, 0, 0.1) 0px 0px 1px 0px;
        }

        /* Active Menu for Mobile */
        @media (max-width: 768px) {
           .map{
                z-index: 1;
            }
            .nav-links {
                position: absolute;
                top: 70px;
                right: 30px;
                background-color: #286449;
                border-radius: 8px;
                padding: 20px;
                display: none;
                flex-direction: column;
                gap: 15px;
                box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
                z-index: 2;
            }
            .nav-links.active {
                display: flex;
            }

            .hamburger {
                display: flex;
            }

            .hamburger.open span:nth-child(1) {
                transform: rotate(45deg);
                position: absolute;
                top: 5px;
            }

            .hamburger.open span:nth-child(2) {
                opacity: 0;
            }

            .hamburger.open span:nth-child(3) {
                transform: rotate(-45deg);
                position: absolute;
                top: -5px;
            }
        }











        


  /* Reset and Base */
* {
  box-sizing: border-box;
}

h2 {
  margin-bottom: 8px;
  font-weight: 700;
  color: #222;
}

p {
  margin-top: 0;
  margin-bottom: 24px;
  color: #555;
  font-size: 14px;
}

/* Containers */
.form-container,
.table-container {
  background: #fff;
  padding: 1.5rem;
  border-radius: 10px;
  box-shadow: 0 4px 16px rgba(0, 100, 0, 0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.form-container:hover,
.table-container:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(0, 100, 0, 0.15);
}

/* Buttons */
.btn-dark-green {
  background: linear-gradient(90deg, #064d1d, #0a5f25);
  color: white;
  border: none;
  transition: background 0.3s ease;
}

.btn-dark-green:hover {
  color: white;
  background: linear-gradient(90deg, #0a5f25, #064d1d);
}

/* Checkmark Animation */
.checkmark-container {
  display: flex;
  justify-content: center;
  margin: 10px 0;
}

.checkmark {
  width: 56px;
  height: 56px;
  stroke-width: 3;
  stroke: #fff;
  fill: none;
  box-shadow: inset 0 0 0 #7ac142;
  border-radius: 50%;
  animation: fill 0.4s ease-in-out 0.4s forwards,
             scale 0.3s ease-in-out 0.9s both;
}

.checkmark-circle {
  stroke-dasharray: 166;
  stroke-dashoffset: 166;
  stroke: #7ac142;
  animation: stroke 0.6s forwards;
}

.checkmark-check {
  stroke-dasharray: 48;
  stroke-dashoffset: 48;
  animation: stroke 0.3s 0.6s forwards;
}

@keyframes stroke {
  to {
    stroke-dashoffset: 0;
  }
}

@keyframes scale {
  50% {
    transform: scale(1.1);
  }
}

@keyframes fill {
  to {
    box-shadow: inset 0 0 0 30px #7ac142;
  }
}

/* Div Show/Hide */
#div1 {
  display: block;
}

#div2 {
  display: none;
}

/* Table Styles */
.table1,
table {
  border-collapse: collapse;
  width: 100%;
  background-color: white;
  margin-bottom: 20px;
}

.table1 thead,
thead {
  background-color: #2e8b57;
  color: white;
}

th,
td {
  border: 1px solid #ccc;
  padding: 5px 5px;
  text-align: left;
  min-width: 120px;
  font-size: 11px;
}

th {
  font-weight: bold;
  background-color: green;
}

td[contenteditable="true"] {
  background-color: #f9fbff;
  cursor: text;
  outline: none;
}

td[contenteditable="true"]:focus {
  background-color: #ffffcc;
  outline: 2px solid #4caf50;
  box-shadow: inset 0 0 0 2px #4a90e2;
}

tbody tr:hover td {
  background-color: #f0f6ff;
}

/* Responsive Table */
.table_div {
  width: 100%;
  height: 300px;
  overflow: auto;
}

.table-responsive {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

@media (max-width: 600px) {

  .d1, .d2{
    margin-top: 10px;
  }

  .content1{
    width: 100%;
  }

  table {
    max-width: 90px;
  }

  th,
  td {
    padding: 10px 12px;
  }
}

/* Map */
#map {
  height: 600px;
}

/* Map Marker Icon */
.number-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background-color: rgba(0, 123, 255, 0.6);
  color: white;
  font-size: 12px;
  font-weight: bold;
  text-align: center;
  transition: transform 0.3s, background-color 0.3s;
}

.number-icon:hover {
  transform: scale(1.2);
  background-color: rgba(0, 123, 255, 0.8);
}

.number-icon .icon-text {
  font-size: 12px;
  font-weight: bold;
  color: white;
}

.buttondiv{
  width: 100%;
  height: 50px;
box-shadow: rgba(0, 0, 0, 0.15) 0px 5px 15px 0px;

background-color: rgba(128, 128, 128, 0.5);
}





  .modal.fade .modal-dialog {
      transform: translateY(-50px); /* Start position above */
      opacity: 0; /* Invisible */
      transition: opacity 0.4s ease, transform 0.4s ease; /* Smooth transition for both opacity and transform */
    }

    /* When the modal becomes visible */
    .modal.fade.show .modal-dialog {
      transform: translateY(0); /* Move to its normal position */
      opacity: 1; /* Fully visible */
    }



    .modaldiv{
      height: 400px;
      overflow: auto;
    }




      @media print {
      body * {
        visibility: hidden !important;
      }

      #map, #map * {
        visibility: visible !important;
      }

      #map {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 9999 !important;
      }}
    



      .content1 {
  position: relative;
  width: 100%;
  transition: margin 0.3s ease;
  right: 4px;
}


  </style>
  
  
</head>
<body>

  <header>
    <nav class="top-bar">
        <div class="logo">Land Map</div>


        <ul class="nav-links">
            <li><a href="#"><i class="fas fa-info-circle"></i> About</a></li>
            <li><a href="#"><i class="fas fa-cogs"></i> Services</a></li>
            <li><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
        </ul>

              <div class="hamburger" id="hamburger">
                  <span></span>
                  <span></span>
                  <span></span>
              </div>
          </nav>
      </header>



  <div class="buttondiv mt-2  " >
   
  <button id="togglePointsBtn" class="btn btn-success btn-sm mt-2 mx-2">Hide Points</button>
   <button id="togglePointsBtn" class="btn btn-success btn-sm mt-2 mx-2"> <i class="bi bi-map"></i> Topo</button>
 <button id="data" class="btn btn-success btn-sm mt-2 mx-2" data-bs-toggle="modal" data-bs-target="#exampleModal">
    <i class="bi bi-server"></i> Data
  </button>
   <button class="btn btn-success btn-sm mt-2" onclick="printMap()"><i class="bi bi-printer"></i> Print </button>
  </div>  
  

      <div class="row content1 mx-1  p-3 mb-3 mb-md-0" >
     
          <div class="form-container">
            <h4 class="text-success fw-bold mb-sm-3">Map</h4>

      <div id="map" class=" mt-2">

    </div>
  </div>
</div>

  




<!-- Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Data Coordinates</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          

            <button class="btn btn-success btn-sm mt-2" onclick="exportToExcel()">
                <i class="bi bi-file-earmark-excel"></i> Export Excel
                </button>
           <div class="mb-3  d-flex align-items-center mt-3" style="position: relative;">
               <input type="text" id="excelFilename" required class="form-control me-2" value="" placeholder="Enter filename" style="width: 150px;">
                 <select id="coordFormat" class="form-select" onchange="updateTableFormat()">
                  <option value="latlong">Decimal</option>
                  <option value="dms">DMS</option>
                  <option value="utm">UTM</option>
                </select>
              </div>

              
              <div class="modaldiv mt-2">
                 <table id="data-table" class="table table-striped table-hover align-middle mb-0 w-100">
                      <thead class="table-light">
                        <tr>
                          <th>Corner</th>
                          <th>Latitude</th>
                          <th>Longitude</th>
                            <th>Elevation</th>
                        </tr>
                      </thead>
                      <tbody>
                        <!-- Your data here -->
                      </tbody>
                    </table>
              </div>


        </div>
      </div>
    </div>
  </div>


 <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>


   // Hamburger menu toggle
        const hamburger = document.getElementById('hamburger');
        const navLinks = document.querySelector('.nav-links');

        hamburger.addEventListener('click', () => {
            navLinks.classList.toggle('active');
            hamburger.classList.toggle('open');
        });





let originalData = [];

document.addEventListener('DOMContentLoaded', function () {
  loadTableData();

  document.getElementById('coordFormat').addEventListener('change', updateTableFormat);
  document.getElementById('exportBtn').addEventListener('click', exportToExcel);
});

async function loadTableData() {
  try {
    // Dynamically get base URL based on where the frontend is served from
    const baseUrl = `${window.location.protocol}//${window.location.hostname}:3000`;

    // Fetch the IP from the backend
    const ipResponse = await fetch(`${baseUrl}/data/ip`);
    if (!ipResponse.ok) throw new Error('Network response was not ok');
    const ipData = await ipResponse.json();
    const ip = ipData.ip; // Extract IP from response

    // Use the IP to fetch the data
    const dataResponse = await fetch(`http://${ip}:3000/data/display_data`);
    const data = await dataResponse.json();

    originalData = data;
    renderTable(data, 'latlong');
  } catch (error) {
    console.error('Error fetching data:', error);
    const tableBody = document.querySelector('#data-table tbody');
    tableBody.innerHTML = `<tr><td colspan="4" style="color: red;">Error loading data: ${error.message}</td></tr>`;
  }
}

function renderTable(data, format) {
  const tableBody = document.querySelector('#data-table tbody');
  tableBody.innerHTML = '';

  data.forEach(item => {
    const row = document.createElement('tr');
    let latContent, longContent;

    switch (format) {
      case 'dms':
        latContent = decimalToDMS(item.lat, true);
        longContent = decimalToDMS(item.long, false);
        break;
      case 'utm':
        const utm = decimalToUTM(item.lat, item.long);
        latContent = `${utm.easting}E`;
        longContent = `${utm.northing}N`;
        break;
      default:
        latContent = item.lat;
        longContent = item.long;
    }

    row.innerHTML = `
      <td>${item.corner}</td>
      <td class="lat-cell">${latContent}</td>
      <td class="long-cell">${longContent}</td>
      <td>${item.elevation ?? ''}</td>
    `;
    tableBody.appendChild(row);
  });

  updateTableHeaders(format);
}

function updateTableHeaders(format) {
  const headers = document.querySelectorAll('#data-table th');
  if (format === 'utm') {
    headers[1].textContent = 'Easting';
    headers[2].textContent = 'Northing';
  } else {
    headers[1].textContent = 'Latitude';
    headers[2].textContent = 'Longitude';
  }
  headers[3].textContent = 'Elevation';
}

function updateTableFormat() {
  const format = document.getElementById('coordFormat').value;
  renderTable(originalData, format);
}

function decimalToDMS(decimal, isLat) {
  const direction = isLat ? (decimal >= 0 ? 'N' : 'S') : (decimal >= 0 ? 'E' : 'W');
  const absDecimal = Math.abs(decimal);
  const degrees = Math.floor(absDecimal);
  const minutesNotTruncated = (absDecimal - degrees) * 60;
  const minutes = Math.floor(minutesNotTruncated);
  const seconds = ((minutesNotTruncated - minutes) * 60).toFixed(2);
  return `${degrees}° ${minutes}' ${seconds}" ${direction}`;
}

function decimalToUTM(lat, lng) {
  const zone = Math.floor((lng + 180) / 6) + 1;
  const easting = (lng - (-180 + (zone - 1) * 6)) * 111319.9;
  const northing = lat * 110574;
  return {
    zone: zone,
    easting: easting.toFixed(2),
    northing: northing.toFixed(2)
  };
}

function exportToExcel() {
  if (typeof XLSX === 'undefined') {
    alert('Please wait for the export library to load and try again.');
    return;
  }

  let filename = document.getElementById('excelFilename').value.trim() || 'coordinates_data';
  if (!filename.toLowerCase().endsWith('.xlsx')) {
    filename += '.xlsx';
  }

  const format = document.getElementById('coordFormat').value;
  let formatName;
  switch (format) {
    case 'dms':
      formatName = "COORDINATE FORMAT: DMS (Degrees, Minutes, Seconds)";
      break;
    case 'utm':
      formatName = "COORDINATE FORMAT: UTM (Universal Transverse Mercator)";
      break;
    default:
      formatName = "COORDINATE FORMAT: Decimal Degrees";
  }

  const headers = ['Corner'];
  if (format === 'utm') {
    headers.push('Easting', 'Northing');
  } else {
    headers.push('Latitude', 'Longitude');
  }
  headers.push('Elevation');

  const rows = Array.from(document.querySelectorAll('#data-table tbody tr')).map(row =>
    Array.from(row.cells).map(cell => cell.textContent)
  );

  const worksheetData = [
    [formatName],
    [],
    headers,
    ...rows
  ];

  const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
  if (!worksheet['!merges']) worksheet['!merges'] = [];
  worksheet['!merges'].push({
    s: { r: 0, c: 0 },
    e: { r: 0, c: headers.length - 1 }
  });

  worksheet['A1'].s = {
    font: { bold: true, sz: 14 },
    alignment: { horizontal: 'center' }
  };

  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "Coordinates");
  XLSX.writeFile(workbook, filename);
}

// Load XLSX if not present
if (typeof XLSX === 'undefined') {
  const script = document.createElement('script');
  script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
  document.head.appendChild(script);
}







        //map

  const map = L.map('map').setView([0, 0], 2);

L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Function to abbreviate the corner name (first 2 uppercase letters)
function abbreviateCorner(corner) {
  if (!corner) return '';
  const uppercaseLetters = corner.match(/[A-Z]/g);
  if (uppercaseLetters && uppercaseLetters.length > 1) {
    return uppercaseLetters.join('').slice(0, 2);
  } else if (corner.length > 2) {
    return corner.slice(0, 2).toUpperCase();
  }
  return corner.toUpperCase();
}

// Function to create a custom icon for the marker
function createNumberIcon(label) {
  const text = abbreviateCorner(label);
  return L.divIcon({
    className: 'number-icon',
    html: `<div>${text}</div>`,
    iconSize: [24, 24],
    iconAnchor: [12, 12]
  });
}

let markers = [], polyline = null, areMarkersVisible = true;
const toggleBtn = document.getElementById('togglePointsBtn');
toggleBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  areMarkersVisible = !areMarkersVisible;
  markers.forEach((m) => {
    areMarkersVisible ? map.addLayer(m) : map.removeLayer(m);
  });
  toggleBtn.textContent = areMarkersVisible ? 'Hide Points' : 'Show Points';
});

// Fetch the data from the backend
async function fetchData() {
  try {
    // Dynamically get base URL based on where the frontend is served from
    const baseUrl = `${window.location.protocol}//${window.location.hostname}:3000`;

    // First fetch - get IP info from backend
    const response = await fetch(`${baseUrl}/data/ip`);
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    const ipData = await response.json();
    const ip = ipData.ip; // Get the IP

    // Fetch the coordinates data using the IP
    const coordinatesResponse = await fetch(`http://${ip}:3000/data/display_data`);
    const data = await coordinatesResponse.json();

    const validData = data
      .map((coord, i) =>
        typeof coord.lat === 'number' && typeof coord.long === 'number' && typeof coord.elevation === 'number'
          ? { latlng: [coord.lat, coord.long], corner: coord.corner || `Point ${i + 1}`, elevation: coord.elevation }
          : null
      )
      .filter(Boolean);

    if (validData.length === 0) {
      const info = L.control({ position: 'topright' });
      info.onAdd = () => {
        const el = L.DomUtil.create('div');
        el.innerHTML = '<strong>No data to display!</strong>';
        el.style.background = 'white';
        el.style.padding = '8px';
        el.style.borderRadius = '4px';
        return el;
      };
      info.addTo(map);
      console.error("No valid coordinates.");
      return;
    }

    // Create markers from valid data
    markers = validData.map((pt) => {
      const marker = L.marker(pt.latlng, {
        icon: createNumberIcon(pt.corner),
        riseOnHover: true
      })
        .bindPopup(
          `<b>${pt.corner}</b><br>Lat: ${pt.latlng[0].toFixed(4)}<br>Long: ${pt.latlng[1].toFixed(4)}<br>Elevation: ${pt.elevation} m`
        )
        .addTo(map);

      marker.on('mouseover', () => marker.setZIndexOffset(1000));
      marker.on('mouseout', () => marker.setZIndexOffset(0));
      return marker;
    });

    // Create polyline if there are at least two valid points
    if (validData.length >= 2) {
      polyline = L.polyline(validData.map((pt) => pt.latlng), {
        color: 'blue',
        weight: 4,
        opacity: 0.7
      }).addTo(map);
      map.fitBounds(validData.map((pt) => pt.latlng));
    }

  } catch (err) {
    console.error("Fetch error:", err);
  }
}

// Trigger map click event to show popup with coordinates
map.on('click', (e) => {
  L.popup()
    .setLatLng(e.latlng)
    .setContent(`Lat: ${e.latlng.lat.toFixed(4)}<br>Long: ${e.latlng.lng.toFixed(4)}`)
    .openOn(map);
});

// Print map
function printMap() {
  window.print();
}

// Call fetchData on page load
fetchData();

  </script>

</body>
</html>
